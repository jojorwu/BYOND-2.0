# Внутреннее устройство виртуальной машины (VM)

Виртуальная машина (VM) является сердцем движка BYOND 2.0. Это стековая, кооперативно многозадачная виртуальная машина, отвечающая за выполнение скомпилированного DM-байткода, который определяет всю игровую логику. VM спроектирована для обеспечения высокой производительности, надежности и безопасного выполнения скриптов.

## Ключевые компоненты

### 1. DreamThread

`DreamThread` — это основной компонент, отвечающий за выполнение байткода. Каждый `DreamThread` представляет собой отдельный, независимый поток выполнения в VM, аналогичный потоку в операционной системе, но управляемый планировщиком движка.

*   **Стек вызовов (`Stack<CallFrame>`):** Каждый поток имеет свой собственный стек вызовов, в котором хранятся структуры `CallFrame`. `CallFrame` — это легковесная структура, которая содержит важную информацию о текущей выполняемой процедуре:
    *   `PC` (Program Counter): Целое число, указывающее на следующую инструкцию для выполнения в байткоде процедуры.
    *   `StackBase`: Целое число, указывающее на базу кадра текущей процедуры в стеке значений. Это позволяет эффективно получать доступ к локальным переменным и аргументам.
*   **Стек значений (`List<DreamValue>`):** Это динамически изменяемый список, который служит рабочей памятью для потока. Все значения — локальные переменные, аргументы, возвращаемые значения и промежуточные результаты вычислений — помещаются и извлекаются из этого стека. Использование `List` вместо `Stack` позволяет осуществлять доступ по индексу, что крайне важно для извлечения локальных переменных и аргументов относительно `StackBase`.

### 2. Байткод и опкоды

VM выполняет байткод, сгенерированный компилятором OpenDream из исходных файлов `.dme` и `.dm`. Этот байткод является переносимым, промежуточным представлением игровой логики.

*   **Опкоды:** Байткод состоит из последовательности инструкций, называемых опкодами. Каждый опкод — это один байт, который соответствует определенной операции, такой как:
    *   `PushString`, `PushFloat`: Поместить константное значение в стек значений.
    *   `Add`, `Subtract`: Выполнить арифметические операции над двумя верхними значениями стека.
    *   `Call`: Вызвать другую процедуру.
    *   `Jump`, `JumpIfFalse`: Управлять потоком выполнения.
*   **Диспетчеризация опкодов:** Ядром `DreamThread` является его цикл выполнения, который использует большой оператор `switch` для диспетчеризации опкодов. Это высокоэффективный механизм, который позволяет JIT-компилятору оптимизировать диспетчеризацию в таблицу переходов.

### 3. DreamValue

`DreamValue` — это универсальный тип значения (структура), используемый для представления всех типов данных DM, включая числа, строки, объекты и типы. Этот подход на основе структуры с дискриминированным объединением позволяет VM обрабатывать различные типы данных типобезопасным и эффективным способом без накладных расходов на упаковку (boxing) для простых типов, таких как float.

## Жизненный цикл выполнения

1.  **Загрузка (`DreamMakerLoader`):** При загрузке скриптов сервис `DreamMakerLoader` считывает JSON-вывод компилятора. Он заполняет `DreamVM` определениями процедур (`DreamProc`) и информацией о типах объектов (`ObjectType`), подготавливая их к выполнению.
2.  **Создание потока:** Для выполнения процедуры (например, точки входа `world.New()`) `ScriptManager` создает новый `DreamThread`. Поток инициализируется с `CallFrame` для целевой процедуры.
3.  **Цикл выполнения (`DreamThread.Run`)**: Планировщик `ScriptHost` вызывает метод `Run` для потока, предоставляя временной бюджет на текущий тик. Поток входит в свой основной цикл:
    а.  Он считывает следующий опкод из потока байткода.
    б.  Он использует оператор `switch` для перехода к обработчику этого опкода.
    в.  Обработчик выполняет свою операцию (например, манипулирует стеком значений, изменяет `PC`).
    г.  Цикл продолжается до тех пор, пока не будет исчерпан временной бюджет, процедура не вернет значение или поток не завершит выполнение.
4.  **Кооперативная многозадачность:** `ScriptHost` использует планировщик, который управляет всеми активными `DreamThread`. На каждом игровом тике планировщик запускает каждый поток на небольшой временной срез. Если работа потока не завершена, его состояние сохраняется, и он будет возобновлен на последующем тике. Эта кооперативная модель обеспечивает отзывчивость сервера и предотвращает зависание всей игры из-за одного длительного скрипта.
