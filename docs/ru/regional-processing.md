# Игровой цикл и региональная обработка

Сервер BYOND 2.0 спроектирован для поддержки игр различных масштабов. В его основе лежит **игровой цикл (Game Loop)**, который отвечает за продвижение состояния игры с каждым тиком. Сервер может работать в двух основных режимах: простом **глобальном игровом цикле** и высокопроизводительном **цикле с региональной обработкой**.

## Глобальный игровой цикл (по умолчанию)

Это режим по умолчанию, и он наиболее прост для понимания. Когда в файле `server_config.json` для параметра `EnableRegionalProcessing` установлено значение `false`, сервер использует `GlobalGameLoopStrategy`.

### Как это работает

1.  На каждом тике сервера `GameLoop` последовательно перебирает **каждый игровой объект** и **каждый поток скриптов** во всем игровом мире.
2.  Он выполняет логику для каждого из них.

*   **Плюсы:** Простота, предсказуемость и пригодность для небольших игр или игр с одной картой, где производительность не является главной проблемой.
*   **Минусы:** Плохо масштабируется. По мере увеличения количества объектов и игроков время, необходимое для завершения одного тика, растет линейно, что может привести к серьезному снижению производительности (лагам).

## Цикл с региональной обработкой

Для больших игр с открытым миром обработка каждого объекта на каждом тике неэффективна. Система региональной обработки решает эту проблему, обрабатывая только те части мира, которые релевантны для игроков. Этот режим включается установкой `EnableRegionalProcessing` в `true` в файле `server_config.json`.

### Как это работает

При включении этого режима сервер использует `RegionalGameLoopStrategy`, которая следует более сложной процедуре:

1.  **Разделение мира:** Игровой мир делится на сетку **регионов** фиксированного размера.
2.  **Активация регионов:** На каждом тике `RegionManager` определяет, какие регионы являются "активными". По умолчанию это зависит от близости игроков. Любой регион в пределах определенного диапазона (`ActivationRange`) от игрока помечается как активный. Скрипты также могут принудительно активировать регионы с помощью `IRegionApi`.
3.  **Слияние регионов (опционально):** Если `EnableRegionMerging` установлено в `true`, система находит группы смежных активных регионов и объединяет их в один `MergedRegion`. Это оптимизация, которая снижает накладные расходы на планирование задач, так как одной большой задачей управлять эффективнее, чем множеством маленьких.
4.  **Параллельное выполнение:** Затем `GameLoop` обрабатывает активные регионы.
    *   Сначала он выполняет все "глобальные" потоки скриптов, которые не привязаны к конкретному объекту или местоположению.
    *   Затем он перебирает каждый активный `Region` (или `MergedRegion`). Для каждого региона создается отдельная задача (`Task.Run`), которая выполняет логику **только для объектов и потоков скриптов, находящихся в этом регионе**.
    *   Это позволяет серверу обрабатывать разные части карты параллельно, используя несколько ядер процессора.

Неактивные регионы фактически "замораживаются" — их объекты и скрипты не обрабатываются, что значительно экономит вычислительные ресурсы.

## Конфигурация

Система региональной обработки настраивается в файле `server_config.json`:

```json
{
  "EnableRegionalProcessing": true,
  "EnableRegionMerging": false,
  "MinRegionsToMerge": 2,
  "ActivationRange": 1,
  "ZActivationRange": 0
}
```

*   `EnableRegionalProcessing`: Включает или отключает всю систему.
*   `EnableRegionMerging`: Включает или отключает слияние смежных активных регионов.
*   `MinRegionsToMerge`: Минимальное количество смежных активных регионов, необходимое для формирования `MergedRegion`.
*   `ActivationRange`: Радиус (в регионах) вокруг игрока, который будет активирован. Значение `1` активирует область 3x3 вокруг игрока.
*   `ZActivationRange`: Количество Z-уровней выше и ниже игрока, которые будут активированы.
