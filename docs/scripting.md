# Скриптинг

Игровой движок BYOND 2.0 использует Lua в качестве языка для написания скриптов. Это позволяет разработчикам быстро изменять и расширять игровую логику без необходимости перекомпиляции всего проекта.

## Движок Lua

Интеграция с Lua осуществляется с помощью библиотеки NLua, которая обеспечивает связь между C# и Lua. Это позволяет вызывать функции C# из Lua и наоборот.

## Горячая перезагрузка

Одной из ключевых особенностей движка является горячая перезагрузка скриптов. Сервер отслеживает изменения в файлах в каталоге `scripts` и автоматически перезагружает их при обнаружении изменений. Это значительно ускоряет процесс разработки, так как изменения в игровой логике можно увидеть в реальном времени без перезапуска сервера.

Механизм горячей перезагрузки реализован с использованием `FileSystemWatcher` и имеет защиту от многократных срабатываний (debouncing) с помощью `System.Threading.Timer`.

## Точка входа

Основной точкой входа для скриптов является файл `scripts/main.lua`. При запуске сервера или после горячей перезагрузки этот файл выполняется первым. Если в настройках проекта (`project.json`) указана `MainMap`, эта карта будет загружена до выполнения `main.lua`. В `main.lua` должна находиться основная логика инициализации игрового мира и другие важные компоненты.

## API `Game`

Для взаимодействия с игровым миром из Lua скриптов предоставляется глобальный объект `Game`. Этот объект является экземпляром класса `GameApi` из C# и предоставляет набор методов для управления состоянием игры.

### Управление картой

#### `Game:CreateMap(width, height, depth)`
Создает новую карту с указанными размерами.

*   `width`: Ширина карты (целое число).
*   `height`: Высота карты (целое число).
*   `depth`: Глубина карты (целое число).

**Пример:**
```lua
-- Создание карты размером 50x50x1
Game:CreateMap(50, 50, 1)
```

### Управление объектами

#### `Game:CreateObject(typeName, x, y, z)`
Создает новый игровой объект указанного типа в заданных координатах.

*   `typeName`: Имя типа объекта (строка).
*   `x`, `y`, `z`: Координаты для создания объекта (целые числа).

**Пример:**
```lua
-- Создание объекта типа "wall" в координатах (10, 5, 0)
local wall = Game:CreateObject("wall", 10, 5, 0)
```

#### `Game:MoveObject(objectId, newX, newY, newZ)`
Перемещает существующий игровой объект в новые координаты.

*   `objectId`: Уникальный идентификатор объекта (целое число).
*   `newX`, `newY`, `newZ`: Новые координаты объекта (целые числа).

**Пример:**
```lua
-- Перемещение объекта с ID `wall.Id` в (11, 5, 0)
Game:MoveObject(wall.Id, 11, 5, 0)
```

#### `Game:DestroyObject(objectId)`
Удаляет игровой объект из мира.

*   `objectId`: Уникальный идентификатор объекта (целое число).

**Пример:**
```lua
-- Удаление объекта
Game:DestroyObject(wall.Id)
```

### Свойства объектов

#### `Game:SetObjectProperty(objectId, key, value)`
Устанавливает значение свойства для игрового объекта.

*   `objectId`: Уникальный идентификатор объекта (целое число).
*   `key`: Имя свойства (строка).
*   `value`: Новое значение свойства (может быть строкой, числом, булевым значением).

**Пример:**
```lua
-- Установка свойства "health" для объекта
Game:SetObjectProperty(player.Id, "health", 100)
```

#### `Game:GetObjectProperty(objectId, key)`
Получает значение свойства игрового объекта.

*   `objectId`: Уникальный идентификатор объекта (целое число).
*   `key`: Имя свойства (строка).

**Пример:**
```lua
-- Получение свойства "health"
local playerHealth = Game:GetObjectProperty(player.Id, "health")
print("Player health: " .. tostring(playerHealth))
```
