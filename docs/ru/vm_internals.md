# Внутреннее устройство виртуальной машины (VM)

Виртуальная машина (VM) является сердцем движка BYOND 2.0. Она отвечает за выполнение скомпилированного DM-байткода, который определяет всю игровую логику. VM спроектирована для обеспечения высокой производительности и надежности.

## Ключевые компоненты

### 1. DreamThread

`DreamThread` — это основной компонент, отвечающий за выполнение байткода. Каждый `DreamThread` представляет собой отдельный поток выполнения в VM, аналогичный потоку в операционной системе, но работающий в кооперативном многозадачном режиме.

*   **Стек вызовов (`CallStack`):** Каждый поток имеет свой собственный стек вызовов, в котором хранятся `CallFrame`. `CallFrame` содержит информацию о текущей выполняемой процедуре, такую как Program Counter (PC) и указатель на базу стека.
*   **Стек значений (`ValueStack`):** Это стек, в котором хранятся все значения (локальные переменные, аргументы, промежуточные результаты вычислений).

### 2. Байткод и опкоды

VM выполняет байткод, который генерируется компилятором OpenDream. Байткод представляет собой последовательность инструкций (опкодов), которые VM может понимать и выполнять. Каждый опкод соответствует определенной операции, такой как арифметические вычисления, вызовы процедур или управление потоком выполнения.

### 3. DreamValue

`DreamValue` — это универсальная структура данных, используемая для представления всех типов значений в DM, таких как числа, строки, объекты и т.д. Это позволяет VM работать с различными типами данных единым образом.

## Жизненный цикл выполнения

1.  **Загрузка:** `DreamMakerLoader` загружает скомпилированный JSON-файл, содержащий байткод, и подготавливает его для выполнения в VM.
2.  **Создание потока:** Для выполнения процедуры (например, `world.New()`) создается новый `DreamThread`.
3.  **Цикл выполнения:** `DreamThread` входит в цикл, в котором он последовательно читает и выполняет опкоды из байткода. Этот цикл продолжается до тех пор, пока процедура не завершится или пока не будет достигнут лимит инструкций, выделенный на текущий тик.
4.  **Кооперативная многозадачность:** VM использует кооперативную многозадачность. Каждый поток выполняется в течение короткого промежутка времени (тика), а затем приостанавливается, чтобы дать возможность другим потокам выполниться. Это обеспечивает отзывчивость сервера и предотвращает зависание из-за длительных скриптов.
