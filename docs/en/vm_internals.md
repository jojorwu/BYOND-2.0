# Virtual Machine (VM) Internals

The Virtual Machine (VM) is the heart of the BYOND 2.0 engine. It is responsible for executing the compiled DM bytecode that defines all game logic. The VM is designed for high performance and reliability.

## Key Components

### 1. DreamThread

A `DreamThread` is the primary component responsible for executing bytecode. Each `DreamThread` represents a single thread of execution within the VM, similar to an operating system thread but operating in a cooperative multitasking environment.

*   **Call Stack (`CallStack`):** Each thread has its own call stack, which stores `CallFrame`s. A `CallFrame` contains information about the currently executing procedure, such as the Program Counter (PC) and a pointer to the stack base.
*   **Value Stack (`ValueStack`):** This is the stack where all values (local variables, arguments, intermediate calculation results) are stored.

### 2. Bytecode and Opcodes

The VM executes bytecode generated by the OpenDream compiler. Bytecode is a sequence of instructions (opcodes) that the VM can understand and execute. Each opcode corresponds to a specific operation, such as arithmetic calculations, procedure calls, or control flow management.

### 3. DreamValue

`DreamValue` is a universal data structure used to represent all DM value types, such as numbers, strings, objects, etc. This allows the VM to handle different data types in a unified way.

## Execution Lifecycle

1.  **Loading:** The `DreamMakerLoader` loads the compiled JSON file containing the bytecode and prepares it for execution in the VM.
2.  **Thread Creation:** To execute a procedure (e.g., `world.New()`), a new `DreamThread` is created.
3.  **Execution Loop:** The `DreamThread` enters a loop where it sequentially reads and executes opcodes from the bytecode. This loop continues until the procedure completes or until the instruction limit allocated for the current tick is reached.
4.  **Cooperative Multitasking:** The VM uses cooperative multitasking. Each thread runs for a short period (a tick) and then pauses to allow other threads to run. This ensures server responsiveness and prevents long-running scripts from causing freezes.
